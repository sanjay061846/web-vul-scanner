"""
Web Application Vulnerability Scanner
Author : Student Name
Tool   : Python IDLE
"""

import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin

requests.packages.urllib3.disable_warnings()

class WebVulnerabilityScanner:

    def __init__(self, target_url):
        self.target_url = target_url
        self.session = requests.Session()
        self.crawled_urls = set()

    def start_scan(self):
        print("\n[INFO] Starting Web Vulnerability Scan")
        print(f"[TARGET] {self.target_url}\n")

        self.check_security_headers()
        self.check_robots_txt()
        self.crawl(self.target_url)

        print("\n[INFO] Scan Completed Successfully")

    def crawl(self, url):
        if url in self.crawled_urls:
            return

        self.crawled_urls.add(url)

        try:
            response = self.session.get(url, verify=False, timeout=5)
        except requests.RequestException:
            return

        soup = BeautifulSoup(response.text, "html.parser")

        self.analyze_forms(url, soup)

        for link in soup.find_all("a"):
            href = link.get("href")
            if href:
                full_url = urljoin(url, href)
                if self.target_url in full_url:
                    self.crawl(full_url)

    def analyze_forms(self, url, soup):
        forms = soup.find_all("form")

        for form in forms:
            print(f"[FORM FOUND] {url}")
            self.test_xss(form, url)
            self.test_sql_injection(form, url)

    def test_xss(self, form, url):
        payload = "<script>alert('XSS')</script>"
        action = form.get("action")
        method = form.get("method", "get").lower()
        target = urljoin(url, action)

        data = {}
        for input_tag in form.find_all("input"):
            name = input_tag.get("name")
            if name:
                data[name] = payload

        response = self.submit_form(target, method, data)

        if response and payload in response.text:
            print("⚠️  XSS VulnerABILITY DETECTED")

    def test_sql_injection(self, form, url):
        payload = "' OR '1'='1"
        action = form.get("action")
        method = form.get("method", "get").lower()
        target = urljoin(url, action)

        data = {}
        for input_tag in form.find_all("input"):
            name = input_tag.get("name")
            if name:
                data[name] = payload

        response = self.submit_form(target, method, data)

        if response:
            error_signatures = ["sql", "mysql", "syntax", "database"]
            for error in error_signatures:
                if error in response.text.lower():
                    print("⚠️  SQL INJECTION VULNERABILITY DETECTED")
                    break

    def submit_form(self, url, method, data):
        try:
            if method == "post":
                return self.session.post(url, data=data, verify=False)
            else:
                return self.session.get(url, params=data, verify=False)
        except requests.RequestException:
            return None

    def check_security_headers(self):
        response = self.session.get(self.target_url, verify=False)
        headers = response.headers

        print("[INFO] Checking Security Headers")

        security_headers = [
            "Content-Security-Policy",
            "X-Frame-Options",
            "X-XSS-Protection",
            "Strict-Transport-Security"
        ]

        for header in security_headers:
            if header not in headers:
                print(f"⚠️  Missing Header: {header}")

    def check_robots_txt(self):
        robots_url = urljoin(self.target_url, "/robots.txt")
        response = self.session.get(robots_url, verify=False)

        if response.status_code == 200:
            print("⚠️  robots.txt File Accessible")

# Program Execution Starts Here
if __name__ == "__main__":
    target_url = input("Enter Target URL (http://example.com): ")
    scanner = WebVulnerabilityScanner(target_url)
    scanner.start_scan()
